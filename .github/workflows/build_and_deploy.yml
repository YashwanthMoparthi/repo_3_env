name: Deploy Snowpark Apps

on:
  pull_request:
    branches:
      - master
      - dev
      - test
      - release
    types:
      - closed
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Select the target branch for deployment'
        required: true
        default: 'dev'
        options:
          - dev
          - test
          - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target_branch: [dev, test, release]

    steps:
      - name: Set Environment Variables
        run: |
          echo "TARGET_BRANCH=${{ matrix.target_branch }}" >> $GITHUB_ENV
          echo "SNOWSQL_ACCOUNT=${{ secrets[format('SNOWSQL_ACCOUNT_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_USER=${{ secrets[format('SNOWSQL_USER_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_PWD=${{ secrets[format('SNOWSQL_PWD_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_ROLE=${{ secrets[format('SNOWSQL_ROLE_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_WAREHOUSE=${{ secrets[format('SNOWSQL_WAREHOUSE_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_DATABASE=${{ secrets[format('SNOWSQL_DATABASE_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SNOWSQL_SCHEMA=${{ secrets[format('SNOWSQL_SCHEMA_{0}', matrix.target_branch)] }}" >> $GITHUB_ENV
          echo "SCRIPT_PATH=$(find $GITHUB_WORKSPACE -name 'command_center_deploy.py' | head -n 1)" >> $GITHUB_ENV

      - name: Debug Script Location
        run: ls -l $GITHUB_WORKSPACE

      - name: Debug Script Location
        run: ls -l $SCRIPT_PATH

      - name: Set Execute Permission
        run: chmod +x $SCRIPT_PATH

      - name: List Directory Contents
        run: ls -l $GITHUB_WORKSPACE

      - name: Check Target Branch
        run: |
          echo "Deploying to $TARGET_BRANCH branch"

      - name: Deploy Snowpark apps
        run: python $SCRIPT_PATH --root_directory=$GITHUB_WORKSPACE --files_list="${{ steps.filenames.outputs.all }}"
